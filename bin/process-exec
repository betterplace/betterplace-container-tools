#!/bin/sh

set -e

PROCESS=$1
test -z $PROCESS && echo >&2 require processname as first argument

echo -n Prepare app configuration…
if [ -z "$REVISION" ]
then
  echo >&2 Need REVISION env var to configure app!
  exit 1
fi
cd public
if [ ! -e manifests.done ]
then
  wget -O manifests.tar.gz "https://storage.googleapis.com/$COMPILED_ASSETS_BUCKET/manifests.tar.gz-$REVISION"
  tar xzf manifests.tar.gz
  if [ "$OVERWRITE_ASSET_HOSTNAME" == "1" ]
  then
    # Beware this changes all hostnames in URLs, but it's always the same hostname (for now?)
    ruby -ruri -i -e "BEGIN { r = ENV.fetch('ASSET_HOSTNAME') + ?. + URI.parse(ENV.fetch('ROOT_URL')).host }; print ARGF.read.gsub(URI.regexp) { |u| u = URI.parse(u); u.host = r; u.to_s }" packs/manifest.json
    gzip -c packs/manifest.json > packs/manifest.json.gz
  fi
  rm manifests.tar.gz
  touch manifests.done
fi
cd -
echo done.
process_call=`grep "$PROCESS:" Procfile | head -1 | sed "s/$PROCESS: *//"`
echo Executing process \"$process_call\"…
test -e process-exec-started || touch process-exec-started
SKIP_SIGNAL_LOG=SIGURG AFTER='sudo /app/bin/terminate_cloud_sql_proxy' exec bundle exec binit $process_call
